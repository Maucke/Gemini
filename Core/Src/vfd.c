#include "vfd.h"	 
#include <stdio.h>
#include <stdlib.h> 
#include "config.h"

u8 VRAM[24*7][2];
u8 VBAK[24*7][2];
u8 VCORN[5] = {0};
u8 VPNT[2] = {0};

//G1,G2,G3,G4,G5,G6,G7,G8,G9,G10,G11,G12,G13,G14
unsigned char VFD_DCRAM[14] = {0x07,'1','3','-','S','T','-','8','4','G','I','N','K',0x07};	//DCRAM
unsigned char VFD_CGRAM[8][5] = {				//CGRAM
	0x08,0x1c,0x3e,0x00,0x3e,	//left arrow
	0x3e,0x00,0x3e,0x1c,0x08,	//right arrow
	0x28,0x2c,0x2e,0x2c,0x28,	//up arrow
	0x0a,0x1a,0x2a,0x1a,0x0a,	//down arrow
	0x55,0x55,0x55,0x55,0x55,
	0x55,0x55,0x55,0x55,0x55,
	0x55,0x55,0x55,0x55,0x55,
	0x55,0x55,0x55,0x55,0x55
};
//NC,TIME_D1,SHIFT_D1,CLOCK_D1,HD_D1,USB_D1,LOCK_D1,DOLBY_D1,MUTE_D1,TU1_D1,TU2_D1,MP3_D1,LOOP_D1,NC,NC,NC,:1_D0,:2_D0,:3_d0
unsigned char VFD_ADRAM[19] = {0x00,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x00};			//ADRAM


const u8 VFD_Font[]=
{
	0x7f,0x41,0x41,0x7f,0x7f, // 0
	0x00,0x00,0x7f,0x7f,0x00, // 1
	0x79,0x79,0x49,0x49,0x4f, // 2
	0x41,0x49,0x49,0x7f,0x7f, // 3
	0x0e,0x08,0x08,0x7f,0x7f, // 4
	0x4f,0x49,0x49,0x79,0x79, // 5
	0x7f,0x49,0x49,0x79,0x78, // 6
	0x01,0x01,0x01,0x7f,0x7f, // 7
	0x7f,0x49,0x49,0x7f,0x7f, // 8
	0x0f,0x49,0x49,0x7f,0x7f, // 9
	0x7F,0x7F,0x09,0x09,0x7F, // A
	0x7F,0x7F,0x49,0x4F,0x78, // B
	0x7f,0x7f,0x41,0x41,0x41, // C
	0x7F,0x7F,0x41,0x41,0x7E, // D
	0x7F,0x7F,0x49,0x49,0x41, // E
	0x7F,0x7F,0x09,0x09,0x01, // F
	0x7F,0x7F,0x41,0x49,0x79, // G
	0x7F,0x7F,0x08,0x08,0x7F, // H
	0x41,0x7F,0x7F,0x41,0x00, // I
	0x61,0x41,0x7F,0x7F,0x01, // J
	0x7F,0x7F,0x1C,0x36,0x63, // K
	0x7F,0x7F,0x40,0x40,0x60, // L
	0x7F,0x03,0x07,0x03,0x7F, // M
	0x7F,0x7F,0x04,0x08,0x7F, // N
	0x7F,0x7F,0x41,0x41,0x7F, // O
	0x7f,0x7f,0x11,0x11,0x1f, // P
	0x7F,0x7F,0x41,0x61,0x7F, // Q
	0x7F,0x7F,0x09,0x79,0x4F, // R
	0x4F,0x4F,0x49,0x49,0x79, // S
	0x01,0x7F,0x7F,0x01,0x01, // T
	0x7f,0x7f,0x40,0x40,0x7f, // U
	0x7F,0x7F,0x30,0x0C,0x03, // V
	0x7F,0x60,0x70,0x60,0x7F, // W
	0x71,0x19,0x7F,0x4C,0x47, // X
	0x0F,0x0F,0x78,0x08,0x0F, // Y
	0x63,0x51,0x49,0x45,0x63, // Z
	0x00,0x00,0x36,0x36,0x00, // :
	0x40,0x40,0x40,0x40,0x40, // _
	0x00,0x1F,0x13,0x13,0x03, // ¡æ
	0x00,0x00,0x00,0x00,0x00, //  
	0x10,0x18,0x18,0x18,0x08, // -
	0x55,0xAA,0x55,0xAA,0x55, // 
};

const u8 VFD_Fonts[][91*5]=
{
{0x00,0x00,0x00,0x00,0x00,/*" ",0*/

0x00,0x00,0x5F,0x00,0x00,/*"!",1*/

0x01,0x00,0x00,0x01,0x00,/*""",2*/

0x7C,0x17,0x14,0x7C,0x17,/*"#",3*/

0x22,0x45,0x7F,0x4B,0x32,/*"$",4*/

0x49,0x37,0x0C,0x72,0x49,/*"%",5*/

0x4F,0x59,0x67,0x78,0x48,/*"&",6*/

0x00,0x01,0x00,0x00,0x00,/*"'",7*/

0x00,0x00,0x3E,0x41,0x00,/*"(",8*/

0x00,0x61,0x1E,0x00,0x00,/*")",9*/

0x14,0x0C,0x3E,0x0C,0x14,/*"*",10*/

0x08,0x08,0x3E,0x08,0x08,/*"+",11*/

0x40,0x40,0x00,0x00,0x00,/*",",12*/

0x08,0x08,0x08,0x08,0x08,/*"-",13*/

0x40,0x40,0x00,0x00,0x00,/*".",14*/

0x40,0x30,0x08,0x06,0x01,/*"/",15*/

0x3E,0x51,0x49,0x45,0x3E,/*"0",16*/

0x00,0x00,0x02,0x7F,0x00,/*"1",17*/

0x42,0x61,0x51,0x49,0x46,/*"2",18*/

0x21,0x41,0x45,0x4B,0x31,/*"3",19*/

0x18,0x14,0x12,0x7F,0x10,/*"4",20*/

0x2F,0x45,0x45,0x45,0x39,/*"5",21*/

0x3E,0x49,0x49,0x49,0x31,/*"6",22*/

0x01,0x01,0x79,0x05,0x03,/*"7",23*/

0x36,0x49,0x49,0x49,0x36,/*"8",24*/

0x26,0x49,0x49,0x49,0x3E,/*"9",25*/

0x00,0x00,0x24,0x00,0x00,/*":",26*/

0x00,0x00,0x44,0x00,0x00,/*";",27*/

0x08,0x14,0x22,0x22,0x41,/*"<",28*/

0x14,0x14,0x14,0x14,0x14,/*"=",29*/

0x41,0x22,0x22,0x14,0x08,/*">",30*/

0x07,0x01,0x51,0x09,0x07,/*"?",31*/

0x3E,0x5D,0x63,0x5F,0x61,/*"@",32*/

0x60,0x1C,0x13,0x1C,0x60,/*"A",33*/

0x7F,0x49,0x49,0x49,0x76,/*"B",34*/

0x3f,0x41,0x41,0x41,0x22,/*"C",35*/

0x7F,0x41,0x41,0x41,0x3E,/*"D",36*/

0x7F,0x49,0x49,0x49,0x41,/*"E",37*/

0x7F,0x09,0x09,0x09,0x01,/*"F",38*/

0x3E,0x41,0x41,0x51,0x32,/*"G",39*/

0x7F,0x08,0x08,0x08,0x7F,/*"H",40*/

0x00,0x41,0x7F,0x41,0x00,/*"I",41*/

0x20,0x40,0x41,0x3F,0x01,/*"J",42*/

0x7F,0x08,0x0C,0x32,0x41,/*"K",43*/

0x7F,0x40,0x40,0x40,0x40,/*"L",44*/

0x7F,0x0C,0x30,0x0C,0x7F,/*"M",45*/

0x7F,0x02,0x0C,0x10,0x7F,/*"N",46*/

0x3E,0x41,0x41,0x41,0x3E,/*"O",47*/

0x7F,0x09,0x09,0x09,0x06,/*"P",48*/

0x3E,0x41,0x41,0x61,0x7E,/*"Q",49*/

0x7F,0x09,0x09,0x39,0x46,/*"R",50*/

0x46,0x49,0x49,0x49,0x31,/*"S",51*/

0x01,0x01,0x7F,0x01,0x01,/*"T",52*/

0x3F,0x40,0x40,0x40,0x3F,/*"U",53*/

0x03,0x1C,0x60,0x1C,0x03,/*"V",54*/

0x1F,0x60,0x1F,0x60,0x1F,/*"W",55*/

0x41,0x36,0x08,0x36,0x41,/*"X",56*/

0x03,0x04,0x78,0x04,0x03,/*"Y",57*/

0x61,0x51,0x49,0x45,0x43,/*"Z",58*/

0x00,0x00,0x7F,0x00,0x00,/*"[",59*/

0x01,0x06,0x08,0x30,0x40,/*"\",60*/

0x00,0x00,0x7F,0x00,0x00,/*"]",61*/

0x00,0x00,0x00,0x00,0x00,/*"^",62*/

0x08,0x08,0x08,0x08,0x08,/*"-",63*/

0x00,0x01,0x00,0x00,0x00,/*"'",64*/

0x68,0x54,0x54,0x54,0x78,/*"a",65*/

0x7F,0x48,0x44,0x44,0x38,/*"b",66*/

0x38,0x44,0x44,0x44,0x48,/*"c",67*/

0x38,0x44,0x44,0x44,0x7F,/*"d",68*/

0x38,0x54,0x54,0x54,0x18,/*"e",69*/

0x04,0x7E,0x45,0x05,0x05,/*"f",70*/

0x78,0x24,0x24,0x54,0x48,/*"g",71*/

0x7F,0x04,0x04,0x04,0x78,/*"h",72*/

0x04,0x44,0x7D,0x40,0x00,/*"i",73*/

0x00,0x00,0x04,0x05,0x79,/*"j",74*/

0x7F,0x10,0x10,0x2C,0x44,/*"k",75*/

0x00,0x41,0x7F,0x40,0x00,/*"l",76*/

0x78,0x04,0x7C,0x04,0x04,/*"m",77*/

0x7C,0x08,0x04,0x04,0x78,/*"n",78*/

0x38,0x44,0x44,0x44,0x38,/*"o",79*/

0x7C,0x44,0x44,0x44,0x38,/*"p",80*/

0x38,0x44,0x44,0x44,0x7C,/*"q",81*/

0x44,0x7C,0x08,0x04,0x04,/*"r",82*/

0x68,0x54,0x54,0x54,0x6C,/*"s",83*/

0x04,0x3C,0x44,0x44,0x40,/*"t",84*/

0x3C,0x40,0x40,0x44,0x7C,/*"u",85*/

0x0C,0x34,0x40,0x34,0x0C,/*"v",86*/

0x3C,0x60,0x1C,0x60,0x1C,/*"w",87*/

0x44,0x2C,0x10,0x2C,0x44,/*"x",88*/

0x04,0x1C,0x60,0x1C,0x04,/*"y",89*/

0x44,0x64,0x54,0x4C,0x44},/*"z",90*/
{
0x00,0x00,0x00,0x00,0x00,/*" ",0*/

0x00,0x00,0x5F,0x5F,0x00,/*"!",1*/

0x00,0x00,0x01,0x01,0x00,/*""",2*/

0x30,0x3E,0x7E,0x7E,0x10,/*"#",3*/

0x00,0x47,0x7F,0x79,0x00,/*"$",4*/

0x0F,0x3F,0x7F,0x72,0x70,/*"%",5*/

0x36,0x7F,0x7F,0x7A,0x40,/*"&",6*/

0x00,0x01,0x01,0x00,0x00,/*"'",7*/

0x00,0x00,0x7F,0x7F,0x00,/*"(",8*/

0x00,0x77,0x77,0x00,0x00,/*")",9*/

0x14,0x1C,0x1C,0x1C,0x14,/*"*",10*/

0x08,0x08,0x1C,0x1C,0x08,/*"+",11*/

0x00,0x40,0x40,0x00,0x00,/*",",12*/

0x00,0x08,0x08,0x08,0x00,/*"-",13*/

0x00,0x40,0x40,0x00,0x00,/*".",14*/

0x40,0x78,0x3E,0x07,0x01,/*"/",15*/

0x3E,0x7F,0x41,0x41,0x3E,/*"0",16*/

0x00,0x06,0x7F,0x7F,0x00,/*"1",17*/

0x62,0x73,0x79,0x6F,0x66,/*"2",18*/

0x21,0x61,0x4D,0x7F,0x33,/*"3",19*/

0x1C,0x12,0x7F,0x7F,0x10,/*"4",20*/

0x26,0x67,0x45,0x7D,0x38,/*"5",21*/

0x3E,0x7F,0x4D,0x7D,0x38,/*"6",22*/

0x01,0x71,0x7F,0x0F,0x03,/*"7",23*/

0x36,0x7F,0xc9,0x49,0x36,/*"8",24*/

0x0E,0x5B,0x79,0x7F,0x1E,/*"9",25*/

0x00,0x00,0x00,0x00,0x00,/*":",26*/

0x00,0x00,0x44,0x44,0x00,/*";",27*/

0x08,0x1C,0x36,0x22,0x00,/*"<",28*/

0x14,0x14,0x14,0x14,0x14,/*"=",29*/

0x00,0x22,0x36,0x1C,0x08,/*">",30*/

0x02,0x03,0x09,0x0F,0x06,/*"?",31*/

0x3E,0x7F,0x5F,0x7F,0x3E,/*"@",32*/

0x7E,0x7F,0x09,0x09,0x7E,/*"A",33*/

	0x7F,0x7F,0x49,0x4F,0x70, // B

0x3E,0x7F,0x41,0x63,0x62,/*"C",35*/

0x7F,0x7F,0x41,0x41,0x3E,/*"D",36*/

0x7F,0x7F,0x49,0x49,0x41,/*"E",37*/

0x7F,0x7F,0x09,0x09,0x01,/*"F",38*/

0x3E,0x7F,0x41,0x53,0x32,/*"G",39*/

0x7F,0x7F,0x08,0x08,0x7F,/*"H",40*/

	0x41,0x7F,0x7F,0x41,0x00, // I
	0x61,0x41,0x7F,0x7F,0x01, // J

	0x7F,0x7F,0x1C,0x36,0x63, // K

0x7F,0x7F,0x40,0x40,0x40,/*"L",44*/

0x7F,0x0F,0x3C,0x0F,0x7F,/*"M",45*/

	0x7F,0x7F,0x04,0x08,0x7F, // N

	0x3E,0x7F,0x41,0x41,0x3E, // O

0x7F,0x7F,0x09,0x0F,0x06,/*"P",48*/

	0x3E,0x7F,0x41,0x61,0x7E, // Q

	0x7F,0x7F,0x09,0x79,0x4E, // R

0x66,0x6F,0x49,0x79,0x32,/*"S",51*/

0x01,0x7F,0x7F,0x01,0x01,/*"T",52*/

0x3F,0x7F,0x40,0x40,0x3F,/*"U",53*/

	0x7F,0x7F,0x30,0x0C,0x03, // V

	0x3F,0x78,0x1E,0x78,0x3F, // W
	
	0x71,0x19,0x7F,0x4C,0x47, // X
	0x07,0x0F,0x78,0x0C,0x07, // Y
	0x63,0x73,0x49,0x45,0x63, // Z

0x00,0x00,0x7F,0x7F,0x00,/*"[",59*/

0x00,0x0E,0x7E,0x70,0x00,/*"\",60*/

0x00,0x00,0x00,0x00,0x00,/*"]",61*/

0x00,0x00,0x00,0x00,0x00,/*"^",62*/

0x08,0x08,0x08,0x08,0x08,/*"-",63*/

0x00,0x01,0x01,0x00,0x00,/*"'",64*/

0x68,0x7C,0x7C,0x7C,0x40,/*"a",65*/

0x3F,0x7F,0x44,0x7C,0x38,/*"b",66*/

0x38,0x7C,0x44,0x44,0x00,/*"c",67*/

0x38,0x7C,0x44,0x7F,0x7F,/*"d",68*/

0x28,0x7C,0x54,0x5C,0x18,/*"e",69*/

0x04,0x7E,0x7F,0x05,0x01,/*"f",70*/

0x78,0x7C,0x7C,0x5C,0x04,/*"g",71*/

0x7F,0x7F,0x44,0x7C,0x78,/*"h",72*/

0x00,0x7C,0x7C,0x00,0x00,/*"i",73*/

0x00,0x00,0x7D,0x7D,0x00,/*"j",74*/

0x6F,0x7F,0x7C,0x6C,0x44,/*"k",75*/

0x00,0x7F,0x7F,0x00,0x00,/*"l",76*/

0x7C,0x7C,0x7C,0x78,0x78,/*"m",77*/

0x7C,0x7C,0x44,0x7C,0x78,/*"n",78*/

0x38,0x7C,0x44,0x7C,0x38,/*"o",79*/

0x3C,0x7C,0x44,0x7C,0x38,/*"p",80*/

0x38,0x7C,0x44,0x7C,0x38,/*"q",81*/

0x04,0x7C,0x7C,0x04,0x00,/*"r",82*/

0x00,0x7C,0x7C,0x54,0x00,/*"s",83*/

0x04,0x7C,0x7C,0x44,0x00,/*"t",84*/

0x3C,0x7C,0x44,0x7C,0x78,/*"u",85*/

0x04,0x3C,0x3C,0x1C,0x04,/*"v",86*/

0x1C,0x3C,0x7C,0x7C,0x14,/*"w",87*/

0x44,0x6C,0x7C,0x7C,0x04,/*"x",88*/

0x04,0x1C,0x7C,0x7C,0x04,/*"y",89*/

0x00,0x74,0x7C,0x4C,0x00,}/*"z",90*/
};

const u8 VFD_NumMt[] = 
{
	0x6F,0x49,0x41,0x7F,0x7F,
	0x7F,0x41,0x41,0x7F,0x7F,
	0x7f,0x41,0x41,0x7f,0x7f, // 0
	0x63,0x41,0x41,0x7F,0x7F,
	0x00,0x41,0x4D,0x7F,0x73,
	0x00,0x00,0x7f,0x7f,0x00, // 1
	0x00,0x30,0x79,0x4F,0x06,
	0x00,0x70,0x79,0x4F,0x07,
	0x71,0x71,0x59,0x4D,0x47,
	0x79,0x79,0x49,0x49,0x4f, // 2
	0x49,0x79,0x79,0x49,0x4F,
	0x41,0x49,0x79,0x79,0x4F,
	0x41,0x49,0x49,0x7D,0x7F,
	0x41,0x49,0x49,0x7f,0x7f, // 3
	0x43,0x49,0x48,0x7F,0x7F,
	0x03,0x49,0x48,0x7F,0x7F,
	0x07,0x08,0x48,0x7F,0x7F,
	0x0e,0x08,0x08,0x7f,0x7f, // 4
	0x0E,0x08,0x49,0x7B,0x7B,
	0x0E,0x49,0x49,0x79,0x7B,
	0x4f,0x49,0x49,0x79,0x79, // 5
	0x5F,0x49,0x49,0x79,0x78,
	0x7f,0x49,0x49,0x79,0x78, // 6
	0x7D,0x49,0x41,0x79,0x7C,
	0x61,0x41,0x41,0x7D,0x7E,
	0x01,0x41,0x41,0x7D,0x7F,
	0x01,0x01,0x01,0x7f,0x7f, // 7
	0x01,0x41,0x49,0x7F,0x7F,
	0x63,0x49,0x49,0x7F,0x7F,
	0x7f,0x49,0x49,0x7f,0x7f, // 8
	0x1F,0x49,0x49,0x7F,0x7F,
	0x0f,0x49,0x49,0x7f,0x7f, // 9
};

void VFD_Write(u8 w_data)
{   
	HAL_SPI_Transmit(&hspi2,&w_data,1,20);
}  

void VFD_WR_WORD(u16 DATA) 
{ 
	VFD_STB_Clr(); 
	__ASM("NOP");    
	VFD_Write(DATA>>8);  
	VFD_Write(DATA&0xFF);    
	VFD_STB_Set();    
	__ASM("NOP");    
}  

void VFD_WR_BYTE(u8 DATA)
{
	VFD_STB_Clr(); 
	__ASM("NOP");    
	VFD_Write(DATA&0xFF);    
	VFD_STB_Set();    
	__ASM("NOP"); 
}	

void VFD_Clear(void)
{
	u8 i,j;
	for(i=0;i<24*7;i++)
		for(j=0;j<2;j++)
		{
			VBAK[i][j] = VRAM[i][j];
			VRAM[i][j] = 0x00;
		}
//	for(i=0;i<5;i++)
//		VCORN[i] = 0;
}

void VFD_ClearPart(int x,u8 y,u8 Wid,u8 He)
{
	u8 i,j;
	x+=Delt*7;
	for(j=0;j<He;j++)
		for(i=0;i<Wid;i++)
			VRAM[x+i][y] = 0;
}
void VFD_Fill(u8 Color)
{
	u8 i,j;
	for(i=0;i<24*7;i++)
		for(j=0;j<2;j++)
			VRAM[i][j] = Color;
}


void VFD_Write_CGRAM(unsigned char addr , unsigned char *dat)
{
	unsigned char i;
	VFD_STB_Clr(); 
	VFD_Write(0x40 | addr); 	//write CGRAM
	for(i=0;i<5;i++)
	{
		VFD_Write(*dat++); //CGRAM
	}
	VFD_STB_Set();   
}
void VFD_Init(void)
{ 
#if GEMINI == 1
//	VFD_WR_BYTE(0x6c);    //ÉèÖÃÎ»
//	VFD_WR_WORD(0x53ff);	//ÁÁ¶ÈÉèÖÃFF
//	VFD_WR_BYTE(0x70);    //¿ªÏÔÊ¾
//	VFD_Clear();
//	VFD_Refresh_Vram();

	HAL_Delay(5);
	VFD_WR_BYTE(0x6c);    //ÉèÖÃÎ»
	VFD_Clear();
	VFD_Refresh_Vram();
	VFD_WR_WORD(0x5300);	//ÁÁ¶ÈÉèÖÃFF
	VFD_WR_BYTE(0x70);    //¿ªÏÔÊ¾
#elif MARKC == 1
	VFD_WR_WORD(0xe006); //ÉèÖÃÎ»
	VFD_WR_BYTE(0xa6);    //ÉýÑ¹
	VFD_WR_WORD(0xe400);	//ÁÁ¶È
	VFD_Clear();
	VFD_Refresh_Vram();
	VFD_WR_WORD(0xe800);	//¿ªÏÔÊ¾
#elif TEACH == 1
	VFD_WR_WORD(0xe00d); //ÉèÖÃÎ»
	VFD_WR_WORD(0xe400);	//ÁÁ¶È
	VFD_Refresh_Vram();
	VFD_WR_WORD(0xe800);    //¿ªÏÔÊ¾
	VFD_Write_CGRAM(0x00,VFD_CGRAM[2]);
	
#endif
	
} 

void VFD_Brightness(u16 Bright)
{
	if(Bright>0xFF)
		Bright = 0xFF;
#if GEMINI == 1
	VFD_WR_WORD(0x5300|Bright);	//ÁÁ¶ÈÉèÖÃFF
#elif MARKC == 1
	VFD_WR_WORD(0xe400|Bright);	//ÁÁ¶È
#elif TEACH == 1
	VFD_WR_WORD(0xe400|Bright);	//ÁÁ¶È
#endif
	

}

void VFD_Refresh_Vram(void)
{
#if GEMINI == 1
	int i, j;
	VFD_STB_Clr(); 
	VFD_Write(0xa0);
	for (j = 6; j < 18; j++)
		for (i = 0; i < 5; i++)
			VFD_Write(VRAM[j*7 + i][0]);  
	for (i = 0; i < 5; i++)
		VFD_Write(VCORN[i]);
	VFD_STB_Set();   

	VFD_STB_Clr(); 
	VFD_Write(0x20);
	for (j = 6; j < 18; j++)
		for (i = 0; i < 5; i++)
			VFD_Write(VRAM[j*7 + i][1]);  
	VFD_STB_Set();   
	
	VFD_STB_Clr(); 
	VFD_Write(0x90);
	for (j = 0; j < 13; j++)
		VFD_Write(j);
	VFD_STB_Set();   
	
	VFD_STB_Clr(); 
	VFD_Write(0x10);
	for (j = 0; j < 12; j++)
		VFD_Write(j);
	VFD_STB_Set();   
#elif MARKC == 1
	int i,j;
	for(j=0;j<7;j++)
	{
		VFD_STB_Clr();    
		VFD_Write(0x40+j); 	 //ÏòµØÖ·0x00-0x06Ð´ÈëÊý¾Ý
		for(i=0;i<5;i++)
			VFD_Write(VRAM[j*7+42+i][0]);
		
		VFD_STB_Set();  
		VFD_WR_WORD(((0x20+j)<<8)|(0x00+j));	//ÔÚµØÖ·0x00-0x06¶ÁÈ¡Êý¾ÝÏÔÊ¾
	}
	VFD_STB_Clr();    
	VFD_Write(0x62);	//×ó±ßµÄÃ°ºÅ
	VFD_Write(VPNT[0]);	//×ó±ßµÄÃ°ºÅ
	VFD_Write(0x64);
	VFD_Write(VPNT[1]);	//×ó±ßµÄÃ°ºÅ
	VFD_STB_Set();  
#elif TEACH == 1
	int i,j;
	VFD_STB_Clr(); 
	VFD_Write(0x40); 	//write CGRAM
	for (i=0;i<8;i++)				
	{
		for(j=0;j<5;j++)
		{
			VFD_Write(VFD_CGRAM[i][j]); //CGRAM
		}
	}
VFD_STB_Set(); 
//for(j=0;j<7;j++)
//{
//	VFD_STB_Clr();    
//	VFD_Write(0x40+j); 	 //ÏòµØÖ·0x00-0x06Ð´ÈëÊý¾Ý
//	for(i=0;i<5;i++)
//		VFD_Write(0x5A);
//	
//	VFD_STB_Set();  
//	VFD_WR_WORD(((0x20+j)<<8)|(0x00+j));	//ÔÚµØÖ·0x00-0x06¶ÁÈ¡Êý¾ÝÏÔÊ¾
//}  
	
//	VFD_Write(0x20); 	//write DCRAM
//	for(i=0;i<24;i++)				
//	{
//		VFD_Write(VFD_DCRAM[i]); //DCRAM
//	}
//	VFD_STB_Set();  
	VFD_STB_Clr(); 
	VFD_Write(0X60);	//write ADRAM
	for(i=0;i<19;i++)				
	{
		VFD_Write(VFD_ADRAM[i]); //ADRAM
	}
	VFD_STB_Set();  
#endif
//HAL_Delay(500);
}

void VFD_PNTTIME(void)
{
	static u8 step = 0;
	step++;
	switch(step/4)
	{
		case 0:VPNT[0] = 0x4;VPNT[1] = 0x0;break;
		case 1:VPNT[0] = 0x6;VPNT[1] = 0x4;break;
		case 2:VPNT[0] = 0x6;VPNT[1] = 0x6;break;
		case 3:VPNT[0] = 0x6;VPNT[1] = 0x6;break;
		case 4:VPNT[0] = 0x6;VPNT[1] = 0x6;break;
		case 5:VPNT[0] = 0x2;VPNT[1] = 0x6;break;
		case 6:VPNT[0] = 0x0;VPNT[1] = 0x2;break;
		case 7:VPNT[0] = 0x0;VPNT[1] = 0x0;break;
		case 12:step = 0;break;
	}
}

void VFD_PNTMSG(void)
{
	static u8 step = 0;
	step++;
	switch(step/4)
	{
		case 0:VPNT[0] = 0x4;VPNT[1] = 0x1;break;
		case 1:VPNT[0] = 0x6;VPNT[1] = 0x1;break;
		case 2:VPNT[0] = 0x6;VPNT[1] = 0x1;break;
		case 3:VPNT[0] = 0x6;VPNT[1] = 0x1;break;
		case 4:VPNT[0] = 0x6;VPNT[1] = 0x1;break;
		case 5:VPNT[0] = 0x2;VPNT[1] = 0x1;break;
		case 6:VPNT[0] = 0x0;VPNT[1] = 0x1;break;
		case 7:VPNT[0] = 0x0;VPNT[1] = 0x1;break;
		case 8:step = 0;VPNT[1] = 0x1;break;
	}
}

void VFD_PNTCls(void)
{
	VPNT[0] = 0;VPNT[1] = 0;
}

#define PIXNUM 10
#define PIXCH 5
u8 OneX[PIXNUM][PIXCH],OneY[PIXNUM][PIXCH];
u8 MovX[PIXNUM][PIXCH],MovY[PIXNUM][PIXCH];
u8 OneStaus[PIXNUM][PIXCH] = {0};
u8 OutFlag[PIXNUM][PIXCH] = {0};
u8 StopTime[PIXNUM][PIXCH] = {0};

void VFD_Bow(u8 X,u8 H,u8 Y,u8 PixNum,u8 Ch)
{
	u8 Temp[PIXNUM][PIXCH];
	u8 i;
	for(i=0;i<PixNum;i++)
	{
		if(VFD_ReadPoint(MovX[i][Ch],MovY[i][Ch]))
			VFD_Point(MovX[i][Ch],MovY[i][Ch],0); 
		else
			VFD_Point(MovX[i][Ch],MovY[i][Ch],1); 
		switch(OneStaus[i][Ch])
		{
			case 0:if(StopTime[i][Ch]<4) StopTime[i][Ch]++; else{Temp[i][Ch] = OneX[i][Ch] ; OneX[i][Ch] = rand()%H+X; if(Temp[i][Ch] == OneX[i][Ch]) OneX[i][Ch] = rand()%H+X; OneStaus[i][Ch] = 2;StopTime[i][Ch] = 0;}
				OutFlag[i][Ch] = False;break;
			case 1:if(StopTime[i][Ch]<4) StopTime[i][Ch]++; else{Temp[i][Ch] = OneY[i][Ch] ; OneY[i][Ch] = rand()%Y; if(Temp[i][Ch] == OneY[i][Ch]) OneY[i][Ch] = rand()%Y; OneStaus[i][Ch] = 3;StopTime[i][Ch] = 0;}
				OutFlag[i][Ch] = False;break;
			case 2:if(MovX[i][Ch]>OneX[i][Ch]) {MovX[i][Ch]--;OutFlag[i][Ch] = True;}
				else if(MovX[i][Ch]<OneX[i][Ch]) {MovX[i][Ch]++;OutFlag[i][Ch] = True;}
				else {OneStaus[i][Ch] = 1;OutFlag[i][Ch] = False;} break;
				
			case 3:if(MovY[i][Ch]>OneY[i][Ch]) {MovY[i][Ch]--;OutFlag[i][Ch] = True;}
				else if(MovY[i][Ch]<OneY[i][Ch]) {MovY[i][Ch]++;OutFlag[i][Ch] = True;}
				else {OneStaus[i][Ch] = 0;OutFlag[i][Ch] = False;} break;
		}
		
		if(OutFlag[i][Ch] == True)//·ÀÖ¹×Ô¼ºÏû³ý
		{
			if(VFD_ReadPoint(MovX[i][Ch],MovY[i][Ch]))
				VFD_Point(MovX[i][Ch],MovY[i][Ch],0); 
			else
				VFD_Point(MovX[i][Ch],MovY[i][Ch],1); 
		}
	}
}

u8 VFD_NumMtIndex[] = {0+2,3+2,7+2,11+2,15+2,18+2,20+2,24+2,27+2,29+2};
u8 VFD_DPointMt[][5] = 
{
	0x00,0x00,0x02,0x00,0x00,
	0x00,0x00,0x02,0x02,0x00,
	0x00,0x00,0x02,0x06,0x00,
	0x00,0x00,0x02,0x16,0x00,
	0x00,0x00,0x02,0x36,0x00,
	0x00,0x00,0x22,0x36,0x00,
	0x00,0x00,0x32,0x36,0x00,
	0x00,0x00,0x36,0x36,0x00,
	0x00,0x00,0x34,0x36,0x00,
	0x00,0x00,0x34,0x34,0x00,
	0x00,0x00,0x34,0x30,0x00,
	0x00,0x00,0x34,0x20,0x00,
	0x00,0x00,0x34,0x00,0x00,
	0x00,0x00,0x14,0x00,0x00,
	0x00,0x00,0x04,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,
};


void VFD_F5x7(int x,u8 y,u8 Num,u8 Mtflag)
{
	u8 i;
	static u8 RunS = 0;
	static u8 FNum[12][2];
	static u8 BCount[12][2];
	
	if(Mtflag == True)
	{
		if(Num<=9)
		{
			if(FNum[x/7][y]<VFD_NumMtIndex[Num])
				FNum[x/7][y]++;
			else if(FNum[x/7][y]>VFD_NumMtIndex[Num])
				FNum[x/7][y]=0;
			
			for(i=0;i<5;i++)
				VRAM[x+i][y] = VFD_NumMt[FNum[x/7][y]*5+i];
		}
		else if(Num<=35||Num==38)
		{
			if(VBAK[x][y]!=VFD_Font[Num*5]||VBAK[x+2][y]!=VFD_Font[Num*5+2]||VBAK[x+4][y]!=VFD_Font[Num*5+4])
			{
				for(i=0;i<5;i++)
				{
					if(i%2)
						VRAM[x+i][y] = VBAK[x+i][y]<<1|(VFD_Font[Num*5+i]>>(7-(BCount[x/7][y])%8)&1);
					else
						VRAM[x+i][y] = VBAK[x+i][y]>>1|(VFD_Font[Num*5+i]<<(8-(BCount[x/7][y])%8)&0x80);
				}
				BCount[x/7][y]++;
			}
			else
			{
				for(i=0;i<5;i++)
					VRAM[x+i][y] = VFD_Font[Num*5+i];
				BCount[x/7][y] = 0;
			}
		}
		else if(Num==36)
		{
			RunS++;
			for(i=0;i<5;i++)
				VRAM[x+i][y] = VFD_DPointMt[(RunS/8)%16][i];
		}
		else if(Num==39)
		{
//			if(VBAK[x][y]!=VFD_Font[Num*5]||VBAK[x+2][y]!=VFD_Font[Num*5+2]||VBAK[x+4][y]!=VFD_Font[Num*5+4])
			{
				for(i=0;i<5;i++)
					VRAM[x+i][y] = VFD_Font[Num*5+i];
			}
		}
		else
		{
			if(VBAK[x][y]!=VFD_Font[Num*5]||VBAK[x+2][y]!=VFD_Font[Num*5+2]||VBAK[x+4][y]!=VFD_Font[Num*5+4])
			{
				for(i=0;i<5;i++)
				{
					VRAM[x+i][y] = VBAK[x+i][y]<<1|(VFD_Font[Num*5+i]>>(7-(BCount[x/7][y])%8)&1);
				}
				BCount[x/7][y]++;
			}
			else
			{
				for(i=0;i<5;i++)
					VRAM[x+i][y] = VFD_Font[Num*5+i];
				BCount[x/7][y] = 0;
			}
		}
	}
	else
	{
		for(i=0;i<5;i++)
			VRAM[x+i][y] = VFD_Font[Num*5+i];
	}
}
	

void VFD_SF5x7(int x,u8 y,char *ch,u8 Mtflag)
{
	u8 c=0,j=0;
	x+=Delt*7;
	while(ch[j]!='\0')
	{
		if(ch[j]>='0'&&ch[j]<='9')
			c=ch[j]-'0';
		else if(ch[j]>='A'&&ch[j]<='Z')
			c=ch[j]-'A'+10;
		else if(ch[j]>='a'&&ch[j]<='z')
			c=ch[j]-'a'+10;
		else if(ch[j]==':')
			c=36;
		else if(ch[j]=='#')
			c=38;
		else if(ch[j]==' ')
			c=39;
		else if(ch[j]=='-')
			c=40;
		VFD_F5x7(x,y,c,Mtflag);
		x+=7;
		j++;
	}
}

void VFD_Fs5x7(int x,u8 y,u8 Num,u8 Font)
{
	u8 i;
	static u8 RunS = 0;
//	static u8 FNum[24][2];
	static u8 BCount[24][2];
	
	if(Num==':'-' ')
	{
		RunS++;
		for(i=2;i<4;i++)
			VRAM[x+i][y] = VFD_DPointMt[(RunS/8)%16][i];
	}
	else if(Num==' '-' ')
	{
		if(VBAK[x][y]!=0||VBAK[x+1][y]!=0||VBAK[x+2][y]!=0||VBAK[x+3][y]!=0||VBAK[x+4][y]!=0)
		{
			for(i=0;i<5;i++)
				VRAM[x+i][y] = rand()&VBAK[x+i][y];
		}
	}
	else if(Num<='z'-' ')
	{
		if(VBAK[x][y]!=VFD_Fonts[Font][Num*5]||VBAK[x+2][y]!=VFD_Fonts[Font][Num*5+2])
		{
			for(i=0;i<5;i++)
			{
				if(i%2)
					VRAM[x+i][y] = VBAK[x+i][y]<<1|(VFD_Fonts[Font][Num*5+i]>>(7-(BCount[x/7][y])%8)&1);
				else
					VRAM[x+i][y] = VBAK[x+i][y]>>1|(VFD_Fonts[Font][Num*5+i]<<(8-(BCount[x/7][y])%8)&0x80);
			}
			BCount[x/7][y]++;
		}
		else
		{
			for(i=0;i<5;i++)
				VRAM[x+i][y] = VFD_Fonts[Font][Num*5+i];
			BCount[x/7][y] = 0;
		}
	}
	else
		for(i=0;i<5;i++)
			VRAM[x+i][y] = VFD_Fonts[Font][Num*5+i];
}

void VFD_SFs5x7(int x,u8 y,char *ch,u8 Font)
{
	u8 c=0,j=0;
	x+=Delt*7;
	while(ch[j]!='\0')
	{
		c=ch[j]-' ';
		VFD_Fs5x7(x,y,c,Font);
		x+=7;
		j++;
	}
}

void VFD_Part(int x,u8 y,u8 Wid,u8 He,u8 *ch)
{
	u8 i,j;
	x+=Delt*7;
	for(j=0;j<He;j++)
		for(i=0;i<Wid;i++)
			VRAM[x+i][y] = ch[j*Wid+i];
}

//0/20,2/08d,3/08,4/10,4/40,
void VFD_Corn(VFDCORN corn, u8 State)
{
	switch (corn)
	{
		case DOLBY:if (State) VCORN[2] = VCORN[2] | 0x08; else VCORN[2] = VCORN[2] & ~0x08; break;
		case TIME:if (State) VCORN[4] = VCORN[4] | 0x10; else VCORN[4] = VCORN[4] & ~0x10;  break;
		case CIRCLE:if (State) VCORN[0] = VCORN[0] | 0x20; else VCORN[0] = VCORN[0] & ~0x20; break;
		case MESSG:if (State) VCORN[4] = VCORN[4] | 0x40; else VCORN[4] = VCORN[4] & ~0x40; break;
		case HDCORN:if (State) VCORN[3] = VCORN[3] | 0x08; else VCORN[3] = VCORN[3] & ~0x08; break;
	}
}

//ÏÔÊ¾·¶Î§:X(0-81),Y(0-14)

void VFD_Point(int x,uint8_t y,uint8_t t)
{
	x+=Delt*7;
	if(x>83+Delt*7||y>15)return;//³¬³ö·¶Î§ÁË.
	if(t) VRAM[x][y/8]|=1<<(y%8);
	else VRAM[x][y/8]&=~(1<<(y%8));	  
//	VRAM[x][0] =0xff;
}

u8 VFD_ReadPoint(int x,uint8_t y)
{
	x+=Delt*7;
	if(x>83+Delt*7||y>15)return 0;//³¬³ö·¶Î§ÁË.
	if(VRAM[x][y/8]&(1<<(y%8))) return 1;
	else return 0;
}


#define BLINMAX 5
u16 FucBlin[3][BLINMAX];

VFD_STATUS VFD_FucBlin(u8 Index)
{
	u8 i;
	static float Motion[BLINMAX]={0};
	static u8 Rand[2][12];
	
	for(i=0;i<12;i++)
	{
		if(rand()%200<=Rand[1][i])
		{
			Rand[0][i] = rand()%(GUI_VFD_LCM_XMAX);
			Rand[1][i] = rand()%7;
		}
//		VFD_Point(Rand[0][i],Rand[1][i],1);
	}
	
	switch((u8)Motion[Index])
	{
		case 0:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		break;
		case 1:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		break;
		case 2:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
		break;
		case 3:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
		VFD_Point(FucBlin[0][Index]-1,FucBlin[1][Index],1);
		break;
		case 4:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
		VFD_Point(FucBlin[0][Index]-1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]-1,1);
		break;
		case 5:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
		VFD_Point(FucBlin[0][Index]-1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]-1,1);
		break;
		case 6:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
		VFD_Point(FucBlin[0][Index]-1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]-1,1);
		break;
		case 7:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
		VFD_Point(FucBlin[0][Index]-1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]-1,1);
		break;
		case 8:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
		VFD_Point(FucBlin[0][Index]-1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]-1,1);
		break;
		case 9:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
		VFD_Point(FucBlin[0][Index]-1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]-1,1);
		break;
		case 10:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
		VFD_Point(FucBlin[0][Index]-1,FucBlin[1][Index],1);
		break;
		case 11:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
		break;
		case 12:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
		break;
		case 13:
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		VFD_Point(FucBlin[0][Index],FucBlin[1][Index],1);
		break;
//		default:
//		VFD_Point(FucBlin[0][Index]+1,FucBlin[1][Index],1);
//		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]+1,1);
//		VFD_Point(FucBlin[0][Index]-1,FucBlin[1][Index],1);
//		VFD_Point(FucBlin[0][Index],FucBlin[1][Index]-1,1);
//		break;
	}
	Motion[Index]+=0.34;
	if(Motion[Index] > FucBlin[0][Index]%8+13)
	{
		Motion[Index] = 0;
		return VFD_IDLE;
	}
	return VFD_BUSY;
}

void Motion_Blin(void)
{
	int i;
	for(i=0;i<BLINMAX;i++)
	{
		if(VFD_FucBlin(i) == VFD_IDLE||FucBlin[0][i] == 0)
		{
			FucBlin[0][i] = (rand()%3+1+(rand()%10+1)*7);
			__ASM("NOP");
			FucBlin[1][i] = rand()%13;
		}
	}
}

